<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Email Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #232156;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #232156;
        }

        .section h2 {
            color: #232156;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #232156;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 15px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background: #e9ecef;
            border-color: #232156;
        }

        .file-name {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .email-template {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .email-preview {
            width: 600px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ccc;
            font-family: Arial, sans-serif;
        }

        .email-header, .email-footer {
            background: #232156;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .email-body {
            padding: 20px;
            line-height: 1.6;
        }

        .btn {
            background: #232156;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #1a1940;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .credentials {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .preview-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .email-block {
            border: 1px solid #ccc;
            margin: 10px;
            border-radius: 8px;
            overflow: hidden;
        }

        .email-block-header {
            background: #232156;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        textarea {
            resize: vertical;
            min-height: 150px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .credentials {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💼 Investment Email Generator</h1>
            <p>Upload your files, customize email content, and send investment updates</p>
        </div>

        <!-- File Upload Section -->
        <div class="section">
            <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                1. Upload Files
            </h2>
            
            <div class="two-column">
                <div class="form-group">
                    <label>Word Document (.docx)</label>
                    <div class="file-upload">
                        <input type="file" id="docxFile" accept=".docx" />
                        <label for="docxFile" class="file-upload-label">
                            📄 Click to select Word document<br>
                            <small>Contains deal information and borrower profiles</small>
                        </label>
                        <div class="file-name" id="docxFileName"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>CSV Data File (.csv)</label>
                    <div class="file-upload">
                        <input type="file" id="csvFile" accept=".csv" />
                        <label for="csvFile" class="file-upload-label">
                            📊 Click to select CSV file<br>
                            <small>Contains investment data and client emails</small>
                        </label>
                        <div class="file-name" id="csvFileName"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Template Section -->
        <div class="section">
            <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C2,4.89 21.1,4 20,4Z"/></svg>
                2. Customize Email Content
            </h2>
            
            <div class="form-group">
                <label>Email Subject Template</label>
                <input type="text" class="form-control" id="emailSubject" 
                       value="RE: Investment Update as on {{processing_date}}" 
                       placeholder="Use {{processing_date}} for dynamic date">
            </div>

            <div class="form-group">
                <label>Email Body Template</label>
                <textarea class="form-control" id="emailBody" placeholder="Customize your email body">Dear {{client_names}},

Please find below updated summary of payment details processed on {{processing_date}}.

{{investment_tables}}

Feel free to connect for any clarifications.

Best regards,
Investor Relations Team

{{company_signature}}
{{company_address}}
E-mail: {{company_email}}</textarea>
            </div>

            <div class="two-column">
                <div class="form-group">
                    <label>Company Signature</label>
                    <input type="text" class="form-control" id="companySignature" value="Neo Wealth">
                </div>

                <div class="form-group">
                    <label>Company Email</label>
                    <input type="email" class="form-control" id="companyEmail" value="ir@neoassetmanagement.com">
                </div>
            </div>

            <div class="form-group">
                <label>Company Address</label>
                <input type="text" class="form-control" id="companyAddress" value="123, Example Address, Mumbai, India">
            </div>

            <div class="email-template">
                <h4>Available Placeholders:</h4>
                <p><strong>{{client_names}}</strong> - Names of clients for this email</p>
                <p><strong>{{processing_date}}</strong> - Current processing date</p>
                <p><strong>{{investment_tables}}</strong> - Generated investment tables (HTML)</p>
                <p><strong>{{company_signature}}</strong> - Your company name</p>
                <p><strong>{{company_email}}</strong> - Your company email</p>
                <p><strong>{{company_address}}</strong> - Your company address</p>
            </div>
        </div>

        <!-- SMTP Configuration Section -->
        <div class="section">
            <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M2,3H22C23.05,3 24,3.95 24,5V19C24,20.05 23.05,21 22,21H2C0.95,21 0,20.05 0,19V5C0,3.95 0.95,3 2,3M22,6L12,13L2,6V5L12,12L22,5V6Z"/></svg>
                3. Email Configuration
            </h2>

            <div class="form-group">
                <label>Email Provider</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="gmail" name="emailProvider" value="gmail" checked>
                        <label for="gmail">📧 Gmail</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="outlook" name="emailProvider" value="outlook">
                        <label for="outlook">📧 Outlook</label>
                    </div>
                </div>
            </div>

            <div class="credentials">
                <div class="form-group">
                    <label id="emailLabel">Gmail Address</label>
                    <input type="email" class="form-control" id="senderEmail" placeholder="your.email@gmail.com">
                </div>

                <div class="form-group">
                    <label id="passwordLabel">App Password</label>
                    <input type="password" class="form-control" id="senderPassword" placeholder="16-character app password">
                </div>
            </div>

            <button class="btn btn-secondary" onclick="testConnection()">🔧 Test Connection</button>
            <div id="connectionStatus"></div>
        </div>

        <!-- Action Buttons -->
        <div class="section">
            <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M5,3C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19H5V5H12V3H5M17.78,4C17.61,4 17.43,4.07 17.3,4.2L16.08,5.41L18.58,7.91L19.8,6.7C20.06,6.44 20.06,6 19.8,5.75L18.25,4.2C18.12,4.07 17.95,4 17.78,4M15.37,6.12L8,13.5V16H10.5L17.87,8.62L15.37,6.12Z"/></svg>
                4. Actions
            </h2>

            <button class="btn" onclick="previewEmails()">👁️ Preview Emails</button>
            <button class="btn btn-success" onclick="sendEmails()">📤 Send Emails</button>
            <button class="btn btn-secondary" onclick="downloadLogs()">📄 Download Logs</button>
        </div>

        <!-- Preview Section -->
        <div class="section" id="previewSection" style="display: none;">
            <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>
                Email Preview
            </h2>
            <div class="preview-container" id="previewContainer">
                <!-- Email previews will be generated here -->
            </div>
        </div>

        <!-- Status Section -->
        <div id="statusContainer"></div>
    </div>

    <script>
        // Global variables
        let csvData = null;
        let docxData = null;
        let emailGroups = [];

        // File upload handlers
        document.getElementById('docxFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('docxFileName').textContent = `Selected: ${file.name}`;
                // In a real implementation, you would parse the docx file here
                docxData = { filename: file.name, file: file };
            }
        });

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('csvFileName').textContent = `Selected: ${file.name}`;
                parseCSV(file);
            }
        });

        // Email provider selection
        document.querySelectorAll('input[name="emailProvider"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isGmail = this.value === 'gmail';
                document.getElementById('emailLabel').textContent = isGmail ? 'Gmail Address' : 'Outlook Address';
                document.getElementById('passwordLabel').textContent = isGmail ? 'App Password' : 'Password';
                document.getElementById('senderEmail').placeholder = isGmail ? 'your.email@gmail.com' : 'your.email@outlook.com';
                document.getElementById('senderPassword').placeholder = isGmail ? '16-character app password' : 'Your password';
            });
        });

        // Parse CSV file
        function parseCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                csvData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] ? values[index].trim() : '';
                        });
                        csvData.push(row);
                    }
                }
                showStatus('success', `CSV loaded: ${csvData.length} records found`);
            };
            reader.readAsText(file);
        }

        // Test SMTP connection
        function testConnection() {
            const email = document.getElementById('senderEmail').value;
            const password = document.getElementById('senderPassword').value;
            const provider = document.querySelector('input[name="emailProvider"]:checked').value;

            if (!email || !password) {
                showStatus('error', 'Please enter email and password');
                return;
            }

            // Simulate connection test
            showStatus('info', 'Testing connection...');
            setTimeout(() => {
                showStatus('success', `✅ Connection successful to ${provider} server`);
            }, 2000);
        }

        // Preview emails
        function previewEmails() {
            if (!csvData) {
                showStatus('error', 'Please upload CSV file first');
                return;
            }

            // Group data by email
            const groups = {};
            csvData.forEach(row => {
                const email = row['I_email'] || row['Email'] || 'unknown@email.com';
                if (!groups[email]) {
                    groups[email] = [];
                }
                groups[email].push(row);
            });

            // Generate previews
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';

            Object.entries(groups).forEach(([email, records]) => {
                const emailBlock = createEmailPreview(email, records);
                previewContainer.appendChild(emailBlock);
            });

            document.getElementById('previewSection').style.display = 'block';
            showStatus('success', `Generated ${Object.keys(groups).length} email previews`);
        }

        // Create email preview
        function createEmailPreview(email, records) {
            const container = document.createElement('div');
            container.className = 'email-block';

            const header = document.createElement('div');
            header.className = 'email-block-header';
            header.textContent = `To: ${email} (${records.length} investments)`;

            const preview = document.createElement('div');
            preview.className = 'email-preview';

            // Generate email content
            const clientNames = [...new Set(records.map(r => r['Client Name/ Buyer Name'] || 'Client'))];
            const processingDate = new Date().toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });

            // Create investment tables HTML
            let tablesHtml = '';
            records.forEach(record => {
                tablesHtml += createInvestmentTableHTML(record);
            });

            // Replace placeholders in email body
            let emailBody = document.getElementById('emailBody').value;
            emailBody = emailBody
                .replace(/\{\{client_names\}\}/g, clientNames.join(', '))
                .replace(/\{\{processing_date\}\}/g, processingDate)
                .replace(/\{\{investment_tables\}\}/g, tablesHtml)
                .replace(/\{\{company_signature\}\}/g, document.getElementById('companySignature').value)
                .replace(/\{\{company_email\}\}/g, document.getElementById('companyEmail').value)
                .replace(/\{\{company_address\}\}/g, document.getElementById('companyAddress').value);

            // Convert line breaks to HTML
            emailBody = emailBody.replace(/\n/g, '<br>');

            preview.innerHTML = `
                <div class="email-header">
                    <h3>Neo Wealth Management</h3>
                    <p>Investment Update Report</p>
                </div>
                <div class="email-body">
                    ${emailBody}
                </div>
                <div class="email-footer">
                    <p>© 2025 Neo Wealth Management. All rights reserved.</p>
                    <p>This is an automated email. Please do not reply.</p>
                </div>
            `;

            container.appendChild(header);
            container.appendChild(preview);
            return container;
        }

        // Create investment table HTML
        function createInvestmentTableHTML(record) {
            const securityName = record['Security Name'] || 'Unknown Security';
            return `
                <div style="margin-bottom: 30px;">
                    <table style="width:100%;border:1px solid #666;border-collapse:collapse;font-family:Arial,sans-serif">
                        <tr style="background:#232156;color:#fff">
                            <td colspan="2" style="padding:12px;font-weight:bold">${securityName}</td>
                        </tr>
                        <tr style="background:#f5f5f5">
                            <td style="padding:8px;border:1px solid #666">No. of NCDs (nos.)</td>
                            <td style="padding:8px;border:1px solid #666;text-align:right">${record['No. of NCDs (nos.)'] || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;border:1px solid #666">Face Value</td>
                            <td style="padding:8px;border:1px solid #666;text-align:right">${record['Face Value'] || 'N/A'}</td>
                        </tr>
                        <tr style="background:#f5f5f5">
                            <td style="padding:8px;border:1px solid #666">Opening Principal</td>
                            <td style="padding:8px;border:1px solid #666;text-align:right">${record['Opening Principal Outstanding as on XX date'] || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;border:1px solid #666">Principal Repaid</td>
                            <td style="padding:8px;border:1px solid #666;text-align:right">${record['Principal repaid on "Period"'] || 'N/A'}</td>
                        </tr>
                        <tr style="background:#f5f5f5">
                            <td style="padding:8px;border:1px solid #666">Closing Principal</td>
                            <td style="padding:8px;border:1px solid #666;text-align:right">${record['Closing Principal Outstanding as on XX date'] || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="padding:8px;border:1px solid #666">Net Interest Paid</td>
                            <td style="padding:8px;border:1px solid #666;text-align:right">${record['Net Interest paid for the "Period"'] || 'N/A'}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        // Send emails
        function sendEmails() {
            if (!csvData) {
                showStatus('error', 'Please upload CSV file first');
                return;
            }

            const email = document.getElementById('senderEmail').value;
            const password = document.getElementById('senderPassword').value;

            if (!email || !password) {
                showStatus('error', 'Please configure email credentials');
                return;
            }

            // Simulate sending emails
            showStatus('info', 'Sending emails...');
            
            const groups = {};
            csvData.forEach(row => {
                const emailAddr = row['I_email'] || row['Email'] || 'unknown@email.com';
                if (!groups[emailAddr]) {
                    groups[emailAddr] = [];
                }
                groups[emailAddr].push(row);
            });

            let sent = 0;
            const total = Object.keys(groups).length;

            const sendInterval = setInterval(() => {
                sent++;
                showStatus('info', `Sending emails... ${sent}/${total}`);
                
                if (sent >= total) {
                    clearInterval(sendInterval);
                    showStatus('success', `✅ All ${total} emails sent successfully!`);
                }
            }, 1000);
        }

        // Download logs
        function downloadLogs() {
            const logs = {
                timestamp: new Date().toISOString(),
                csvRecords: csvData ? csvData.length : 0,
                docxFile: docxData ? docxData.filename : 'Not uploaded',
                emailTemplate: document.getElementById('emailBody').value,
                smtpProvider: document.querySelector('input[name="emailProvider"]:checked').value
            };

            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `email_generation_log_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('success', 'Log file downloaded');
        }

        // Show status messages
        function showStatus(type, message) {
            const container = document.getElementById('statusContainer');
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(status);

            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    status.style.opacity = '0.5';
                }, 3000);
            }
        }

        // Initialize default email template
        document.addEventListener('DOMContentLoaded', function() {
            const defaultTemplate = `Dear {{client_names}},

Please find below updated summary of payment details processed on {{processing_date}}.

{{investment_tables}}

Feel free to connect for any clarifications.

Best regards,
Investor Relations Team

{{company_signature}}
{{company_address}}
E-mail: {{company_email}}`;
            
            document.getElementById('emailBody').value = defaultTemplate;
        });
    </script>
</body>
</html>